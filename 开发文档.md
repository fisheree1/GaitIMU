# 开发文档规范化

> 你是一位资深专业的安卓开发，阅读并修改我的开发文档，使其符合标准，专业
> ---
>
> # GaitIMU 开发文档（Android / IMU 步态检测）
>
> ## 1. 项目目标
>
> 开发一款 Android App，利用手机 **IMU（加速度计 Accelerometer + 陀螺仪 Gyroscope）**采集运动数据，并实现：
> 1) 实时采集与可视化（最小可用）
> 2) 数据记录（CSV）与回放（可选）
> 3) 基于 IMU 的步态事件检测：步数、步频、步时等基础指标
> 4) 进阶：姿态/坐标系处理与鲁棒步态参数（可迭代）
>
> ---
>
> ## 2. 当前工程状态（与你截图一致）
>
> 当前目录为 Android Studio 默认 Compose 模板：
>
> - `app/manifests/AndroidManifest.xml`
> - `app/kotlin+java/com.example.gaitimu/`
>   - `MainActivity.kt`
>   - `ui.theme/Color.kt`, `Theme.kt`, `Type.kt`
> - `app/src/main/res/...`
>
> 说明：你现在是 **Jetpack Compose** UI 结构，不需要 `activity_main.xml`，界面写在 `MainActivity.kt`（或拆到 `ui/` 包）。
>
> ---
>
> ## 3. 开发环境与构建
>
> - Android Studio：建议使用较新的稳定版
> - Language：Kotlin
> - UI：Jetpack Compose
> - Min SDK：建议 API 26+
> - 运行设备：真机优先（模拟器 IMU 数据不可靠或不可用）
>
> 构建与运行：
> - Run → 选择真机 → 点击 ▶️
> - 建议开启开发者选项中的 “保持唤醒”（避免采集时黑屏休眠影响）
>
> ---
>
> ## 4. 功能路线与里程碑
>
> ### Milestone 1：采集跑通（MVP）
> - [ ] 识别设备是否存在加速度计与陀螺仪
> - [ ] Start/Stop 控制采集
> - [ ] 实时显示 accel/gyro 数据与采样率估计
> - [ ] 保存 CSV 到 App 私有目录（无需权限）
> - [ ] 基础日志（采集状态、异常）
>
> 交付标准：按下 Start 后能看到数值变化；Stop 后能在本机导出/分享 CSV。
>
> ### Milestone 2：预处理与基础步态指标
> - [ ] 重力估计与线性加速度（去重力）
> - [ ] 平滑滤波（移动平均/低通）
> - [ ] 峰值检测（步数）
> - [ ] 步频 cadence、步时 step time、变异性（std/CV）
> - [ ] UI 显示：Steps / Cadence / Mean step time
>
> 交付标准：走路时步数与步频基本合理，且不同步速有明显区分。
>
> ### Milestone 3：鲁棒性增强
> - [ ] 自适应阈值（随步速变化）
> - [ ] 加入合理步间隔约束（0.3s~1.2s等）
> - [ ] 传感器时间戳对齐与插值（可选）
> - [ ] 佩戴位置适配（裤袋/腰部/手持/脚踝）
>
> ### Milestone 4：姿态与坐标系（进阶）
> - [ ] 使用 `TYPE_ROTATION_VECTOR` 或互补滤波得到姿态
> - [ ] 转换到地球坐标系，提取垂直方向线性加速度
> - [ ] 更稳定的步态事件检测与特征（HS/TO）
>
> ---
>
> ## 5. 推荐包结构（从现在开始就拆）
>
> 建议在 `com.example.gaitimu` 下新增以下包（右键 → New → Package）：
>
> ```
> com.example.gaitimu
>  ├─ ui/                // Compose 界面、状态管理（可选）
>  ├─ sensor/            // 传感器采集与缓冲
>  ├─ signal/            // 滤波、重力估计、工具函数
>  ├─ gait/              // 步态检测与指标计算
>  ├─ io/                // CSV记录、文件导出
>  └─ model/             // 数据模型（Sample, Metrics等）
> ```
>
> ### 各模块职责
>
> **sensor/**
> - `ImuRecorder`: 负责注册/注销传感器监听、采样率控制
> - 输出：统一的数据结构 `ImuSample(timestamp, ax, ay, az, gx, gy, gz)`
>
> **signal/**
> - `LowPassFilter`: 重力估计
> - `MovingAverage`: 平滑
> - `MathUtils`: 向量模长、单位转换等
>
> **gait/**
> - `PeakDetector`: 峰值检测
> - `GaitMetrics`: 根据步事件计算 cadence/step time/variability 等
>
> **io/**
> - `CsvLogger`: 将 `ImuSample` 写入 CSV
> - `FileExporter`（可选）: 分享/导出文件（使用系统 share sheet）
>
> ---
>
> ## 6. 数据流设计（建议采用单向流）
>
> UI（Compose）
> ↓ 触发 Start/Stop
> `ImuRecorder`（采集） → `SampleBuffer`
> ↓（可选：实时预处理）
> `SignalProcessor`（滤波/去重力）
> ↓
> `GaitAnalyzer`（步态检测/指标）
> ↓
> UI 实时展示 + `CsvLogger` 落盘
>
> ---
>
> ## 7. 关键实现规范
>
> ### 7.1 时间戳使用
> - 传感器事件自带 `event.timestamp`（纳秒，monotonic）
> - 用它做所有“步间隔/采样率”计算
> - 如需显示真实时间，可额外记录 `System.currentTimeMillis()` 做对照，但算法以 timestamp 为准
>
> ### 7.2 采样率策略
> 优先使用：
> - `SENSOR_DELAY_GAME`（一般 ~50Hz-100Hz）
> 或使用：
> - `registerListener(listener, sensor, samplingPeriodUs)`
> 比如 100Hz = 10,000 us
>
> 建议：先固定 50~100Hz，后续再做采样率可配置。
>
> ### 7.3 线程与性能
> - 传感器回调频繁，避免在回调里做重计算/频繁写文件
> - 推荐：回调只做“缓存 + 轻量处理”，落盘用缓冲批量写（例如每 200~500 行 flush）
>
> ---
>
> ## 8. CSV 数据格式（统一标准）
>
> 文件名建议：
> - `imu_yyyyMMdd_HHmmss.csv`
>
> Header（第一行）：
> ```
> t_ns,ax,ay,az,gx,gy,gz
> ```
>
> 单位：
> - `t_ns`: 纳秒
> - `a`：m/s^2（Android accelerometer 默认就是 m/s^2）
> - `g`：rad/s（Android gyroscope 默认就是 rad/s）
>
> 建议追加的可选列（后续迭代）：
> - `a_mag`：加速度模长
> - `a_lin_x/y/z`：去重力后的线性加速度
> - `step_flag`：步事件标记（0/1）
>
> ---
>
> ## 9. 步态检测算法路线（推荐从易到难）
>
> ### 9.1 入门：模长 + 去重力 + 峰值
> 1) `g = lowpass(a)`
> 2) `a_lin = a - g`
> 3) `a_lin_mag = |a_lin|`
> 4) 平滑后做峰值检测
> 5) 峰值间隔约束 + 阈值（可固定或自适应）
>
> 输出：
> - `steps`
> - `cadence`
> - `mean_step_time`
> - `std_step_time` / `CV`
>
> ### 9.2 进阶：姿态辅助
> 使用 `TYPE_ROTATION_VECTOR` 得到姿态，转换到地球坐标系，取垂直方向加速度再检测，通常更稳。
>
> ---
>
> ## 10. UI 规范（Compose）
>
> 建议 UI 有以下区域：
> - 状态栏：采集状态、采样率、文件名
> - 实时值：ax/ay/az、gx/gy/gz、a_lin_mag（可选）
> - 指标：steps、cadence、step time
> - 控制：Start / Stop / Export / Clear
>
> 状态管理建议：
> - 采集状态和指标使用 `mutableStateOf` / `StateFlow`（稍后扩展更容易）
>
> ---
>
> ## 11. 测试计划
>
> ### 11.1 设备测试
> - 静止放桌面：数值稳定（加速度约为重力分量）
> - 手轻晃：a、g 有明显变化
> - 走路：步数随时间增长，cadence 落在合理范围（90~140 steps/min 常见）
>
> ### 11.2 边界情况
> - 无传感器：友好提示（禁用 Start）
> - 暂停/切后台：自动停止采集并保存
> - 超长采集：文件增长稳定，不崩溃、不明显卡顿
>
> ---
>
> ## 12. 风险与注意事项
>
> - **手机放置位置**极大影响波形：裤袋/腰部/手持/脚踝差别很大
> - Android 设备厂商对传感器采样率/滤波可能不同
> - 仅 IMU 推断步长/速度需要模型或标定，MVP 阶段不承诺
>
> ---
>
> ## 13. 开发约定（建议）
>
> - 命名：`ImuSample`, `GaitMetrics`, `PeakDetector`
> - 每次提交前确保：
>   - Start/Stop 不崩
>   - CSV 能写出
>   - 走路能统计步数
>
> ---

下面是我按**资深 Android/IMU 项目文档规范**对你的文档做的“专业化改写版”。我保留了你的目标与路线，但补齐了：**术语统一、非功能要求、权限/存储策略、生命周期行为、数据契约、验收标准、风险边界、目录与接口定义**，让它更像团队可执行的开发规格说明（Dev Spec）。

---

# GaitIMU 开发文档（Android / IMU 步态检测）

## 0. 文档信息
- 文档版本：v1.0
- 适用范围：Android 客户端（Jetpack Compose）
- 读者：Android 开发、算法/信号处理、测试
- 术语说明：
  - IMU：Inertial Measurement Unit（加速度计 + 陀螺仪）
  - accel：Accelerometer（m/s²）
  - gyro：Gyroscope（rad/s）
  - ts：timestamp（优先使用 SensorEvent.timestamp，单位 ns）

---

## 1. 项目背景与目标

### 1.1 背景
使用手机 IMU 采集运动数据，并在端侧实现基础步态事件检测与指标统计，为后续姿态/坐标系处理与更鲁棒的步态参数迭代奠定数据与工程基础。

### 1.2 目标（分阶段交付）
**MVP（必须）**
1) 实时采集 IMU（accel + gyro）
2) 实时可视化关键数值与采样率估计
3) 记录原始数据到 CSV（App 私有目录，免权限）
4) Start/Stop 稳定、生命周期正确、无明显掉帧/卡顿

**增强（可选）**
1) 数据回放（基于 CSV）
2) 预处理（去重力、平滑滤波）
3) 步态事件检测与基础指标（步数/步频/步时）

**进阶（迭代）**
1) 姿态/坐标系转换（地球坐标系、垂直方向信号）
2) 更鲁棒事件（如 HS/TO）与更多参数

### 1.3 非目标（明确边界）
- MVP 不承诺步长、速度、能量消耗等需要标定/模型的推断结果
- 不保证所有厂商设备采样率一致（仅保证兼容与可用性）

---

## 2. 工程状态与技术栈

### 2.1 当前工程结构
当前为 Android Studio 默认 **Jetpack Compose** 模板：
- `AndroidManifest.xml`
- `MainActivity.kt`
- `ui.theme/*`
- `res/*`

> Compose 项目无需 `activity_main.xml`。UI 由 Composable 构建，推荐拆分到 `ui/` 目录。

### 2.2 技术选型
- 语言：Kotlin
- UI：Jetpack Compose
- 最低版本：建议 API 26+
- 设备：真机优先（模拟器 IMU 不稳定或不可用）

---

## 3. 功能范围与里程碑（含验收标准）

### Milestone 1：采集与落盘（MVP）
**需求**
- 识别加速度计/陀螺仪可用性（缺失则禁用 Start 并提示）
- Start/Stop 控制采集
- 实时展示 accel/gyro 及采样率估计（Hz）
- CSV 保存到 App 私有目录（无需存储权限）
- 基础日志：采集状态、异常、文件路径/大小

**验收**
- Start 后数值随运动变化；Stop 后停止更新
- 生成 CSV 文件且可通过系统分享导出
- 采集 2 分钟无崩溃、无明显 UI 卡顿

### Milestone 2：预处理与基础步态指标
**需求**
- 去重力：估计重力向量并输出线性加速度
- 平滑滤波（移动平均或低通）
- 峰值检测（步数）
- 指标：cadence、mean step time、std/CV
- UI 展示 Steps / Cadence / Mean Step Time

**当前实现（2026-02-25）**
- 已从 App 主流程移除步态功能（去重力、平滑、峰值计步、步态指标 UI）
- 当前仅保留 IMU 采集、采样率显示、CSV 记录与导出

**验收**
- 正常行走 cadence 落入合理区间（常见 90–140 steps/min）
- 快走/慢走能体现明显差异
- 步数随时间单调增加，停走后增长停止

### Milestone 3：鲁棒性增强
- 自适应阈值（随幅度/步速变化）
- 步间隔约束（例如 0.3s–1.2s，可配置）
- timestamp 对齐与插值（可选）
- 佩戴位置适配策略（记录/提示模式）

### Milestone 4：姿态与坐标系（进阶）
- `TYPE_ROTATION_VECTOR` 或互补滤波获取姿态
- 转地球坐标系，提取垂直方向线性加速度
- 更稳定事件检测（HS/TO）与拓展参数

---

## 4. 权限、存储与导出策略（标准化）

### 4.1 权限
- 传感器无需运行时权限
- CSV 默认保存到 **App 私有目录**：无需读写外部存储权限
- 导出分享建议使用 **系统 Share Sheet**（FileProvider / SAF）

### 4.2 文件路径建议
- 私有目录：`context.filesDir/` 或 `context.getExternalFilesDir(null)`
  - 若希望更易导出/可见：优先 `getExternalFilesDir()`（仍免权限）
- 文件命名：`imu_yyyyMMdd_HHmmss.csv`

### 4.3 导出策略（建议）
- 通过 `Intent.ACTION_SEND` + `FileProvider` 共享
- 不直接写公共 Download 目录，避免权限与 Android 版本差异

---

## 5. 生命周期与行为规范（避免采集类常见坑）

### 5.1 前后台/旋转/进程
- App 进入后台（onStop）建议：**自动 Stop 并 flush 保存**
- 屏幕旋转：UI 状态使用 ViewModel/StateFlow 保持；采集逻辑与 UI 解耦
- 发生异常/崩溃风险点：文件写入、IO、传感器注销不及时

### 5.2 线程模型
- `SensorEventListener` 回调：只做轻量缓存，不做重计算/频繁 IO
- 落盘：批量写入（例如 200–500 行 flush），IO 放到后台线程
- 算法：可先与采集线程分离（Channel/Buffer → analyzer）

---

## 6. 模块与包结构（推荐落地）

```
com.example.gaitimu
 ├─ ui/                // Compose 页面、状态、UI model
 ├─ sensor/            // 采集、时间戳、缓冲、采样率统计
 ├─ signal/            // 去重力、滤波、数学工具
 ├─ gait/              // 事件检测、指标计算
 ├─ io/                // CSV 落盘、导出分享
 └─ model/             // 数据结构：Sample、Metrics、Config
```

### 6.1 核心接口契约（建议明确）
**model**
- `ImuSample(tsNs, ax, ay, az, gx, gy, gz)`
- `GaitMetrics(steps, cadence, meanStepTime, stdStepTime, cv, lastStepTsNs)`

**sensor**
- `ImuRecorder.start()` / `stop()`
- 回调输出：`onSample(ImuSample)`

**signal**
- `GravityEstimator.update(ax,ay,az) -> gVec`
- `LowPassFilter` / `MovingAverage`

**gait**
- `PeakDetector.update(value, tsNs) -> stepEvent?`
- `GaitAnalyzer.onSample(sample) -> metrics`

**io**
- `CsvLogger.append(sample)` / `flush()` / `close()`
- `FileExporter.share(file)`

---

## 7. 数据流设计（单向数据流）

UI（Start/Stop）
→ ImuRecorder（采集）
→ Buffer（队列/环形缓冲）
→ (可选) SignalProcessor（去重力/滤波）
→ GaitAnalyzer（步态事件/指标）
→ UI 实时展示 + CsvLogger 落盘

> 原则：**UI 不直接持有传感器对象**，以 ViewModel/UseCase 暴露状态与动作。

---

## 8. 时间戳与采样率规范（必须统一）

### 8.1 时间戳
- 使用 `SensorEvent.timestamp`（ns，monotonic）作为算法与间隔计算基准
- 如需墙钟时间用于文件命名/展示：额外记录 `System.currentTimeMillis()`，但不用于算法

### 8.2 采样率
- 初期：`SENSOR_DELAY_GAME`（大致 50–100Hz，设备相关）
- 或指定 `samplingPeriodUs`（例如 100Hz=10,000us）
- 采样率显示：用相邻 sample 的 `Δt` 估计（滑窗平均更稳）

---

## 9. CSV 数据格式（数据契约）

### 9.1 文件命名
- `imu_yyyyMMdd_HHmmss.csv`

### 9.2 Header（第一行）
```
t_ns,ax,ay,az,gx,gy,gz
```

### 9.3 单位
- `t_ns`：纳秒
- `a`：m/s^2
- `g`：rad/s

### 9.4 可选扩展列（后续）
- `a_mag`
- `a_lin_x,a_lin_y,a_lin_z`
- `step_flag`（0/1）
- `cadence,step_time`（用于回放对齐）

---

## 10. 步态检测算法路线（可执行规格）

### 10.1 入门方案（推荐先实现）
1) `g = lowpass(a)`（重力估计）
2) `a_lin = a - g`
3) `v = |a_lin|`
4) `v_smooth = movingAverage(v)`
5) 峰值检测：阈值 + 最小间隔约束
   - `minInterval` 建议默认 300ms
   - `maxInterval` 建议默认 1200ms（用于异常过滤）

**输出**
- `steps`：峰值计数
- `cadence`：最近 N 步平均或滑窗步频（steps/min）
- `mean_step_time`、`std_step_time`、`cv`

### 10.2 进阶方案（姿态辅助）
- `TYPE_ROTATION_VECTOR` → 姿态矩阵/四元数
- 将加速度转换到地球坐标系，取垂直方向线性加速度再检测
- 优点：对手机姿态变化更稳

---

## 11. UI 规范（Compose）

### 11.1 页面布局（建议）
- 顶部状态：Recording / SampleRate / FileName
- 实时传感器：ax/ay/az、gx/gy/gz、(可选) a_lin_mag
- 指标区：Steps / Cadence / Mean Step Time / CV
- 控制区：Start / Stop / Export / Clear

### 11.2 状态管理
- 推荐 ViewModel + `StateFlow`
- UI 仅订阅状态、发送事件（Start/Stop/Export）

---

## 12. 测试计划（可落地）

### 12.1 功能测试
- 静止：accel 约等于重力分量；gyro 接近 0
- 手晃：accel/gyro 变化明显；采样率稳定
- 行走：步数递增；cadence 合理（常见 90–140）

### 12.2 边界测试
- 无传感器：提示 + 禁用 Start
- 切后台/来电：自动 Stop + 文件完整
- 长时间采集：文件增长稳定、无 ANR、无内存持续上涨

---

## 13. 风险与注意事项（明确告知）
- 手机放置位置影响显著（裤袋/手持/腰部/脚踝差异很大）
- 厂商对传感器采样率/滤波实现差异导致波形不一致
- IMU 推断步长/速度属于模型问题，需标定与数据集支持

---

## 14. 开发约定（团队标准）
- 命名：`ImuSample`, `GaitMetrics`, `ImuRecorder`, `PeakDetector`
- 提交前自检：
  - Start/Stop 稳定、退出后台自动 Stop
  - CSV 可写出且可导出
  - 行走可统计步数且大致合理

---

如果你愿意，我可以在你这份文档基础上再补两块“更标准、直接能开工”的内容（不需要你再提供信息也能先给模板）：
1) **接口与状态定义（ViewModel State/Event/Effect 的 Kotlin 结构）**
2) **Milestone 1 的详细实现清单（Manifest、FileProvider、CsvLogger 缓冲写、采样率计算公式、异常处理点）**